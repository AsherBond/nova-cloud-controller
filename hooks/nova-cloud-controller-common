#!/bin/bash
SERVICES="nova-api nova-network nova-objectstore nova-scheduler"
PACKAGES="$SERVICES python-mysqldb"

NOVA_CONF="/etc/nova/nova.conf"

# we'll request credentials via the amqp relation for this user
RABBIT_USER="nova-rabbit"

# the database we'll be requesting via shared-db relations
DB_USER="nova"
NOVA_DB="nova"

# for now we require a network bridge, here's what we'll configure
NETWORK_MANAGER="FlatManager"
NETWORK_BRIDGE="br100"
BRIDGE_IP="11.0.0.1"
BRIDGE_NETMASK="255.255.255.0"

DEFAULT_ETH=$(ip route  | grep default | awk '{ print $5 }')
IP=$(ifconfig  $DEFAULT_ETH | grep 'inet addr' | awk '{ print $2 }' | cut -d: -f2)

function set_or_update {
  # set or update a key=value config option in nova.conf
  KEY=$1
  VALUE=$2
  [[ -z $KEY ]] && exit 1
  [[ -z $VALUE ]] && exit 1
  cat $NOVA_CONF | grep "\-\-$KEY=$VALUE" >/dev/null \
   && ensemble-log "nova-cloud-controller: $KEY=$VALUE already set" exit 0
  if cat $NOVA_CONF | grep "\-\-$KEY=" >/dev/null ; then
    sed -i "s|\(--$KEY=\).*|\1$VALUE|" $NOVA_CONF
  else
    echo "--$KEY=$VALUE" >>$NOVA_CONF
  fi
}

function nova_ctl {
  if [[ $1 == "all" ]] ; then
    CTL=$SERVICES
  else
    CTL=$1
  fi
  ACTION=$2
  if [[ -z $CTL ]] || [[ -z $ACTION ]] ; then
    ensemble-log "ERROR nova_ctl: Not enough arguments"
    exit 1
  fi
  for i in $CTL ; do
    service $i $ACTION
    if [[ $? != 0 ]] ; then
      ensemble-log "ERROR nova_ctl: Service $i failed to $ACTION"
    fi
  done
}

function setup_bridge {
  # XXX This is required by nova-network and will likely move somewhere else
  # once we can split these services up into seperate formulas.
  br=$1
  ip=$2
  netmask=$3
  [[ -z $br ]] && br="br100"
  [[ -z $ip ]] && ip="11.0.0.1"
  [[ -z $netmask ]] && netmask="255.255.255.0"

  apt-get -y install bridge-utils augeas-lenses augeas-tools
  echo "Configuring bridge $br ($ip $netmask)"
  context="/files/etc/network/interfaces"
  augtool <<EOF
  set $context/auto[child::1 = "$br"]/1 $br
  set $context/iface[. = '$br'] $br
  set $context/iface[. = '$br']/family inet
  set $context/iface[. = '$br']/method static
  set $context/iface[. = '$br']/address $ip
  set $context/iface[. = '$br']/netmask $netmask
  set $context/iface[. = '$br']/bridge_ports none 
  save
EOF
  ifdown -a ; ifup -a
}

function configure_network_manager {
  # needed by the nova-network bits
  # to be expanded later to cover flatDhcp and VLAN
  echo "$0: configuring $1 network manager"
  case $1 in
    "FlatManager")
      setup_bridge $NETWORK_BRIDGE $BRIDGE_IP $BRIDGE_NETMASK
      set_or_update network_manager nova.network.manager.FlatManager
      set_or_update flat_network_bridge $NETWORK_BRIDGE
      ;;
    *) echo "ERROR: Invalid network manager $1" && exit 1 ;;
  esac
}

function add_ppa {
  # temporarily find out what nova version we
  # should be using from a source file.  this
  # should go away when ensemble can handle config
  # better.
  if [[ -e $FORMULA_DIR/nova-version ]] ; then
    . $FORMULA_DIR/nova-version
    . /etc/lsb-release
    [[ -z $PPA ]] && return 0
    PPA_URL="deb http://ppa.launchpad.net/nova-core/$PPA/ubuntu $DISTRIB_CODENAME main"
    add-apt-repository "$PPA_URL" || exit 1
  fi
}

